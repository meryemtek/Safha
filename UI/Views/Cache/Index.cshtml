@{
    ViewData["Title"] = "Cache Yönetimi";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-database"></i> Google Books Cache Yönetimi</h4>
                </div>
                <div class="card-body">
                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            @TempData["SuccessMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            @TempData["ErrorMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Cache İstatistikleri</h5>
                                    <div id="cacheStats">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Yükleniyor...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">URL Log İstatistikleri</h5>
                                    <div id="urlLogStats">
                                        <div class="spinner-border text-white" role="status">
                                            <span class="visually-hidden">Yükleniyor...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h6><i class="fas fa-link"></i> URL Cache Durumu Kontrolü</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <input type="url" id="urlInput" class="form-control" 
                                                   placeholder="https://www.googleapis.com/books/v1/volumes?q=..." required>
                                        </div>
                                        <div class="col-md-4">
                                            <button type="button" class="btn btn-primary" onclick="checkUrlCacheStatus()">
                                                <i class="fas fa-search"></i> Cache Durumunu Kontrol Et
                                            </button>
                                        </div>
                                    </div>
                                    <div id="urlStatusResult" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header bg-warning text-dark">
                                    <h6><i class="fas fa-trash"></i> Tüm Cache'i Temizle</h6>
                                </div>
                                <div class="card-body">
                                    <p class="card-text">Tüm cache dosyalarını ve URL log'unu siler. Bu işlem geri alınamaz.</p>
                                    <form method="post" action="@Url.Action("ClearAllCache")" 
                                          onsubmit="return confirm('Tüm cache dosyalarını silmek istediğinizden emin misiniz?')">
                                        <button type="submit" class="btn btn-warning btn-sm">
                                            <i class="fas fa-trash"></i> Tümünü Temizle
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6><i class="fas fa-broom"></i> Eski Cache'i Temizle</h6>
                                </div>
                                <div class="card-body">
                                    <p class="card-text">Süresi dolmuş cache dosyalarını otomatik olarak temizler.</p>
                                    <form method="post" action="@Url.Action("CleanupExpiredCache")">
                                        <button type="submit" class="btn btn-info btn-sm">
                                            <i class="fas fa-broom"></i> Eski Dosyaları Temizle
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h6><i class="fas fa-search"></i> Arama Cache'i Temizle</h6>
                                </div>
                                <div class="card-body">
                                    <p class="card-text">Belirli bir arama sorgusu için cache'i temizler.</p>
                                    <form method="post" action="@Url.Action("ClearSearchCache")" class="d-flex">
                                        <input type="text" name="query" class="form-control form-control-sm me-2" 
                                               placeholder="Arama sorgusu" required>
                                        <button type="submit" class="btn btn-success btn-sm">
                                            <i class="fas fa-search"></i> Temizle
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header bg-secondary text-white">
                                    <h6><i class="fas fa-info-circle"></i> Cache ve URL Log Hakkında</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <h6>Arama Sonuçları Cache'i:</h6>
                                            <ul>
                                                <li>24 saat boyunca geçerli kalır</li>
                                                <li>Aynı arama sorgusu tekrar yapıldığında API'ye istek gönderilmez</li>
                                                <li>Performansı artırır ve API limitlerini korur</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <h6>Kitap Detayları Cache'i:</h6>
                                            <ul>
                                                <li>7 gün boyunca geçerli kalır</li>
                                                <li>Kitap bilgileri değişmez, uzun süre cache'de tutulabilir</li>
                                                <li>Disk alanından tasarruf sağlar</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <h6>URL Log Sistemi:</h6>
                                            <ul>
                                                <li>Tüm API isteklerini kaydeder</li>
                                                <li>Cache durumunu takip eder</li>
                                                <li>Popüler aramaları analiz eder</li>
                                                <li>Performans metrikleri sağlar</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            loadCacheStats();
            loadUrlLogStats();
            
            // Her 30 saniyede bir istatistikleri güncelle
            setInterval(function() {
                loadCacheStats();
                loadUrlLogStats();
            }, 30000);
        });

        function loadCacheStats() {
            $.get('@Url.Action("GetCacheStats")', function(data) {
                if (data.Error) {
                    $('#cacheStats').html('<div class="text-danger">Hata: ' + data.Error + '</div>');
                    return;
                }

                var html = `
                    <div class="row">
                        <div class="col-6">
                            <div class="text-primary">
                                <h3>${data.TotalFiles}</h3>
                                <small>Toplam Dosya</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-info">
                                <h3>${data.TotalSize}</h3>
                                <small>Toplam Boyut</small>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-6">
                            <div class="text-success">
                                <h5>${data.SearchCacheFiles}</h5>
                                <small>Arama Cache</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-warning">
                                <h5>${data.BookCacheFiles}</h5>
                                <small>Kitap Cache</small>
                            </div>
                        </div>
                    </div>
                `;
                
                $('#cacheStats').html(html);
            }).fail(function() {
                $('#cacheStats').html('<div class="text-danger">İstatistikler yüklenemedi</div>');
            });
        }

        function loadUrlLogStats() {
            $.get('@Url.Action("GetUrlLogStats")', function(data) {
                if (data.Error) {
                    $('#urlLogStats').html('<div class="text-danger">Hata: ' + data.Error + '</div>');
                    return;
                }

                var html = `
                    <div class="row">
                        <div class="col-6">
                            <div class="text-white">
                                <h3>${data.TotalRequests}</h3>
                                <small>Toplam İstek</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-white">
                                <h3>${data.Last24Hours}</h3>
                                <small>Son 24 Saat</small>
                            </div>
                        </div>
                    </div>
                    <hr class="text-white">
                    <div class="row">
                        <div class="col-6">
                            <div class="text-white">
                                <h5>${data.SearchRequests}</h5>
                                <small>Arama İsteği</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-white">
                                <h5>${data.BookRequests}</h5>
                                <small>Kitap İsteği</small>
                            </div>
                        </div>
                    </div>
                `;
                
                $('#urlLogStats').html(html);
            }).fail(function() {
                $('#urlLogStats').html('<div class="text-danger">URL log istatistikleri yüklenemedi</div>');
            });
        }

        function checkUrlCacheStatus() {
            var url = $('#urlInput').val().trim();
            if (!url) {
                alert('Lütfen bir URL girin');
                return;
            }

            $('#urlStatusResult').html('<div class="text-center"><div class="spinner-border text-primary" role="status"></div><br>Kontrol ediliyor...</div>');

            $.get('@Url.Action("CheckUrlCacheStatus")', { url: url }, function(data) {
                if (data.Error) {
                    $('#urlStatusResult').html('<div class="alert alert-danger">Hata: ' + data.Error + '</div>');
                    return;
                }

                var statusClass = data.IsCached ? 'success' : 'warning';
                var statusText = data.IsCached ? 'Cache\'de Mevcut' : 'Cache\'de Yok';
                var expiredText = data.IsExpired ? ' (Süresi Dolmuş)' : '';

                var html = `
                    <div class="alert alert-${statusClass}">
                        <h6><i class="fas fa-info-circle"></i> URL Cache Durumu</h6>
                        <hr>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>URL:</strong><br>
                                <small class="text-muted">${data.Url || url}</small>
                            </div>
                            <div class="col-md-6">
                                <strong>Durum:</strong><br>
                                <span class="badge bg-${statusClass}">${statusText}${expiredText}</span>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <strong>Tür:</strong> ${data.Type || 'Bilinmiyor'}<br>
                                <strong>Cache Tarihi:</strong> ${data.CachedAt ? new Date(data.CachedAt).toLocaleString('tr-TR') : 'Cache\'de yok'}<br>
                            </div>
                            <div class="col-md-6">
                                <strong>Sorgu:</strong> ${data.Query || 'Yok'}<br>
                                <strong>Kitap ID:</strong> ${data.BookId || 'Yok'}<br>
                                <strong>Cache Dosyası:</strong> ${data.CacheFileName || 'Yok'}
                            </div>
                        </div>
                    </div>
                `;
                
                $('#urlStatusResult').html(html);
            }).fail(function() {
                $('#urlStatusResult').html('<div class="alert alert-danger">URL durumu kontrol edilemedi</div>');
            });
        }
    </script>
}
