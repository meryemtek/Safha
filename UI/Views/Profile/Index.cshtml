@model UI.Models.ProfileViewModel

@{
    ViewData["Title"] = $"{Model.DisplayName} - Profil";
    Layout = "_Layout";
}

<!-- KullanÄ±cÄ± ID'sini JavaScript iÃ§in gizli alan -->
<input type="hidden" id="profileUserId" value="@Model.Id" />

<div class="profile-container">
        <!-- Ãœst Profil KartÄ± -->
        <div class="profile-header-card">
            <div class="profile-cover">
                <div class="cover-image" style="background-image: url('@(string.IsNullOrEmpty(Model.CoverPhoto) ? "/image/default-cover.jpg" : Model.CoverPhoto)')">
                    @if (Model.IsOwnProfile)
                    {
                        <div class="cover-overlay">
                            <button class="btn btn-edit-cover" onclick="document.getElementById('coverPhotoInput').click()">
                                <i class="icon">ğŸ“·</i> Kapak FotoÄŸrafÄ±nÄ± DeÄŸiÅŸtir
                            </button>
                        </div>
                    }
                </div>
            </div>
            
            <div class="profile-info-section">
                <div class="profile-avatar-container">
                    <div class="profile-avatar" @(Model.IsOwnProfile ? "onclick=\"document.getElementById('profilePhotoInput').click()\"" : "")>
                        <img src="@(string.IsNullOrEmpty(Model.ProfilePicture) ? "/image/default-avatar.jpg" : Model.ProfilePicture)" 
                             alt="@Model.DisplayName" class="avatar-image" />
                        @if (Model.IsOwnProfile)
                        {
                            <div class="avatar-edit-overlay">
                                <i class="icon">âœï¸</i>
                                <span>DÃ¼zenle</span>
                            </div>
                        }
                    </div>
                </div>
                
                <div class="profile-details">
                    <h1 class="profile-name">@Model.DisplayName</h1>
                    <p class="profile-username">@@@Model.Username</p>
                    
                    @if (!string.IsNullOrEmpty(Model.Bio))
                    {
                        <p class="profile-bio">@Model.Bio</p>
                    }
                    
                    <div class="profile-meta">
                        <span class="join-date">
                            <i class="icon">ğŸ“…</i> @Model.MemberSince tarihinde katÄ±ldÄ±
                        </span>
                    </div>
                    
                    <!-- Takip Ä°statistikleri -->
                    <div class="follow-stats">
                        <a href="@Url.Action("Followers", "Profile", new { userId = Model.Id })" class="follow-stat-item">
                            <span class="follow-count">@Model.FollowerCount</span>
                            <span class="follow-label">TakipÃ§i</span>
                        </a>
                        <a href="@Url.Action("Following", "Profile", new { userId = Model.Id })" class="follow-stat-item">
                            <span class="follow-count">@Model.FollowingCount</span>
                            <span class="follow-label">Takip Edilen</span>
                        </a>
                    </div>
                </div>
                
                <div class="profile-actions">
                    @if (Model.IsOwnProfile)
                    {
                        <a href="@Url.Action("Edit", "Profile")" class="btn btn-edit-profile">
                            <i class="icon">âœï¸</i> Profili DÃ¼zenle
                        </a>
                    }
                    else
                    {
                        <button id="followBtn" type="button" class="btn @(Model.IsFollowing ? "btn-following" : "btn-primary")" data-user-id="@Model.Id" data-following="@Model.IsFollowing.ToString().ToLower()">
                            @if (Model.IsFollowing)
                            {
                                <text>Takibi BÄ±rak</text>
                            }
                            else
                            {
                                <text>Takip Et</text>
                            }
                        </button>
                    }
                </div>
            </div>
        </div>



        <!-- Okuma Hedefi -->
        <div class="reading-goal-section">
            <div class="goal-header">
                <h3><i class="fas fa-bullseye"></i> 2025 Okuma Hedefi</h3>
                <span class="goal-progress">@Model.ReadBookCount / @Model.TargetBookCount kitap</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: @Model.ReadingProgress%"></div>
            </div>
            <div class="goal-percentage">%@Model.ReadingProgress tamamlandÄ±</div>
        </div>
        
        <!-- Kitap Durumu KartlarÄ± -->
        <div class="book-status-section">
            <div class="status-header">
                <h3><i class="fas fa-book"></i> @(Model.IsOwnProfile ? "Kitap DurumlarÄ±m" : "Kitap DurumlarÄ±")</h3>
            </div>
            <div class="status-cards">
                <div class="status-card reading">
                    <div class="status-icon">
                        <i class="fas fa-book-open"></i>
                    </div>
                    <div class="status-content">
                        <h4>@(Model.IsOwnProfile ? "Okuyorum" : "Okuyor OlduklarÄ±")</h4>
                        <div class="status-count">@Model.CurrentlyReadingCount</div>
                        <a href="@Url.Action("MyBooks", "Book", new { statusFilter = 2 })" class="status-link">
                            KitaplarÄ± GÃ¶rÃ¼ntÃ¼le <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                </div>
                
                <div class="status-card to-read">
                    <div class="status-icon">
                        <i class="fas fa-bookmark"></i>
                    </div>
                    <div class="status-content">
                        <h4>@(Model.IsOwnProfile ? "OkuyacaklarÄ±m" : "OkuyacaklarÄ±")</h4>
                        <div class="status-count">@Model.WantToReadCount</div>
                        <a href="@Url.Action("MyBooks", "Book", new { statusFilter = 1 })" class="status-link">
                            KitaplarÄ± GÃ¶rÃ¼ntÃ¼le <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                </div>
                
                <div class="status-card completed">
                    <div class="status-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="status-content">
                        <h4>@(Model.IsOwnProfile ? "OkuduklarÄ±m" : "OkuduklarÄ±")</h4>
                        <div class="status-count">@Model.ReadBookCount</div>
                        <a href="@Url.Action("MyBooks", "Book", new { statusFilter = 3 })" class="status-link">
                            KitaplarÄ± GÃ¶rÃ¼ntÃ¼le <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>



        
        <div class="tab-content" id="activity-tab">
            <div class="activity-timeline">
                <div class="timeline-item">
                    <div class="timeline-icon">ğŸ“–</div>
                    <div class="timeline-content">
                        <h4>Kitap Eklendi</h4>
                        <p>Yeni bir kitap kÃ¼tÃ¼phanenize eklendi</p>
                        <span class="timeline-date">@DateTime.Now.AddDays(-1).ToString("dd MMM yyyy")</span>
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-icon">â­</div>
                    <div class="timeline-content">
                        <h4>DeÄŸerlendirme</h4>
                        <p>Bir kitap iÃ§in deÄŸerlendirme yapÄ±ldÄ±</p>
                        <span class="timeline-date">@DateTime.Now.AddDays(-3).ToString("dd MMM yyyy")</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="about-tab">
            <div class="about-section">
                <div class="about-item">
                    <div class="about-icon">ğŸ“§</div>
                    <div class="about-content">
                        <h4>E-posta</h4>
                        <p>@Model.Email</p>
                    </div>
                </div>
                
                @if (!string.IsNullOrEmpty(Model.PhoneNumber))
                {
                    <div class="about-item">
                        <div class="about-icon">ğŸ“±</div>
                        <div class="about-content">
                            <h4>Telefon</h4>
                            <p>@Model.PhoneNumber</p>
                        </div>
                    </div>
                }
                
                @if (!string.IsNullOrEmpty(Model.Address))
                {
                    <div class="about-item">
                        <div class="about-icon">ğŸ“</div>
                        <div class="about-content">
                            <h4>Adres</h4>
                            <p>@Model.Address</p>
                        </div>
                    </div>
                }
                
                <div class="about-item">
                    <div class="about-icon">ğŸ“…</div>
                    <div class="about-content">
                        <h4>Ãœyelik Tarihi</h4>
                        <p>@Model.CreatedAt.ToString("dd MMMM yyyy")</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- AlÄ±ntÄ±lar BÃ¶lÃ¼mÃ¼ -->
        <div class="quotes-section-profile">
            <div class="quotes-header">
                <h3><i class="fas fa-quote-left"></i> Kitap AlÄ±ntÄ±larÄ±</h3>
                @if (Model.IsOwnProfile)
                {
                    <a href="@Url.Action("AddQuote", "Profile")" class="btn btn-primary">
                        <i class="icon">âœï¸</i> Yeni AlÄ±ntÄ± Ekle
                    </a>
                }
            </div>
            
            <div class="quotes-list" id="userQuotesList">
                <div class="loading-quotes">
                    <p>Kitap alÄ±ntÄ±larÄ± yÃ¼kleniyor...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gizli dosya input'larÄ± -->
@if (Model.IsOwnProfile)
{
<input type="file" id="profilePhotoInput" accept="image/*" style="display: none;" onchange="uploadPhoto(this, 'profile')" />
<input type="file" id="coverPhotoInput" accept="image/*" style="display: none;" onchange="uploadPhoto(this, 'cover')" />
}

<!-- CSRF Token -->
@Html.AntiForgeryToken()

@section Styles {
    <link rel="stylesheet" href="~/css/profile.css" />
}

@section Scripts {
    <script src="~/js/profile.js"></script>
    <script>
        // Profil sayfasÄ± yÃ¼klendiÄŸinde kitap durumlarÄ±nÄ± senkronize et
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Profil sayfasÄ± yÃ¼klendi, alÄ±ntÄ±lar yÃ¼kleniyor...');
            
            // Kitap durumu sayÄ±larÄ±nÄ± gÃ¼ncelle (sadece kendi profilinde)
            if (@(Model.IsOwnProfile.ToString().ToLower())) {
                updateBookStatusCounts();
            }
            
            // Kitap durumu gÃ¼ncelleme butonlarÄ±na event listener ekle (sadece kendi profilinde)
            if (@(Model.IsOwnProfile.ToString().ToLower())) {
                setupBookStatusControls();
            }
            
            // KullanÄ±cÄ±nÄ±n alÄ±ntÄ±larÄ±nÄ± yÃ¼kle (kÄ±sa bir gecikme ile)
            setTimeout(() => {
                loadUserQuotes();
            }, 500);
        });



        // Åuan okuyor bÃ¶lÃ¼mÃ¼ kaldÄ±rÄ±ldÄ±

        function updateBookStatusCounts() {
            // AJAX ile gÃ¼ncel kitap durumu sayÄ±larÄ±nÄ± al
            fetch('/Profile/GetBookStatusCounts', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // SayÄ±larÄ± gÃ¼ncelle
                    document.querySelector('.status-card.reading .status-count').textContent = data.currentlyReadingCount;
                    document.querySelector('.status-card.to-read .status-count').textContent = data.wantToReadCount;
                    document.querySelector('.status-card.completed .status-count').textContent = data.readCount;
                    
                    // Åuan okuyor bÃ¶lÃ¼mÃ¼ kaldÄ±rÄ±ldÄ±
                    
                    // Okuma hedefi ilerlemesini gÃ¼ncelle
                    const targetBookCount = @Model.TargetBookCount;
                    const readCount = data.readCount;
                    const progress = targetBookCount > 0 ? Math.round((readCount * 100) / targetBookCount) : 0;
                    
                    document.querySelector('.goal-progress').textContent = `${readCount} / ${targetBookCount} kitap`;
                    document.querySelector('.progress-fill').style.width = `${progress}%`;
                    document.querySelector('.goal-percentage').textContent = `%${progress} tamamlandÄ±`;
                }
            })
            .catch(error => {
                console.error('Kitap durumu sayÄ±larÄ± alÄ±nÄ±rken hata:', error);
            });
            // Takip/Takibi bÄ±rak butonu (baÅŸkasÄ±nÄ±n profili ise)
            const followBtn = document.getElementById('followBtn');
            if (followBtn) {
                followBtn.addEventListener('click', function() {
                    const targetUserId = this.getAttribute('data-user-id');
                    const isFollowing = this.getAttribute('data-following') === 'true';
                    const url = isFollowing ? '/Profile/Unfollow' : '/Profile/Follow';
                    const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: `userId=${targetUserId}&__RequestVerificationToken=${token}`
                    })
                    .then(r => r.json())
                    .then(d => {
                        if (d.success) {
                            this.textContent = isFollowing ? 'Takip Et' : 'Takibi BÄ±rak';
                            this.setAttribute('data-following', (!isFollowing).toString());
                            // Follower count'Ä± gÃ¼ncelle
                            const followerLink = document.querySelector('.follow-stats a[href*="Followers"] .follow-count');
                            if (followerLink && typeof d.followerCount !== 'undefined') {
                                followerLink.textContent = d.followerCount;
                            }
                        }
                        showAlert(d.success ? 'success' : 'danger', d.message || 'Ä°ÅŸlem tamamlandÄ±');
                    })
                    .catch(() => showAlert('danger', 'Bir hata oluÅŸtu'));
                });
            }
        }

        function setupBookStatusControls() {
            // Kitap durumu gÃ¼ncelleme dropdown'larÄ±na event listener ekle
            document.querySelectorAll('.dropdown-item[data-status]').forEach(item => {
                // Ã–nce mevcut event listener'larÄ± kaldÄ±r
                item.removeEventListener('click', handleStatusUpdate);
                // Yeni event listener ekle
                item.addEventListener('click', handleStatusUpdate);
            });
        }

        // Kitap durumu gÃ¼ncelleme event handler'Ä±
        function handleStatusUpdate(e) {
            e.preventDefault();
            const bookId = parseInt(this.dataset.bookId);
            const status = parseInt(this.dataset.status);
            updateBookStatus(bookId, status, this);
        }

        function updateBookStatus(bookId, status, clickedItem) {
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
            
            fetch('/Book/UpdateReadingStatus', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: `bookId=${bookId}&readingStatus=${status}&__RequestVerificationToken=${token}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Dropdown menÃ¼deki aktif durumu gÃ¼ncelle
                    const dropdownItems = clickedItem.closest('.dropdown-menu').querySelectorAll('.dropdown-item');
                    dropdownItems.forEach(item => {
                        item.classList.remove('active');
                    });
                    clickedItem.classList.add('active');
                    
                    // Kitap kartÄ±nÄ±n durumunu gÃ¼ncelle
                    const bookCard = clickedItem.closest('.book-card');
                    if (bookCard) {
                        bookCard.className = `book-card status-${status}`;
                        
                        // Durum butonunu gÃ¼ncelle
                        const statusButton = bookCard.querySelector('.dropdown-toggle');
                        if (statusButton) {
                            const statusIcon = statusButton.querySelector('.status-icon');
                            const statusText = statusButton.querySelector('.status-text');
                            
                            if (statusIcon) statusIcon.textContent = GetStatusIcon(status);
                            if (statusText) statusText.textContent = GetStatusText(status);
                        }
                    }
                    
                    // Kitap durumu sayÄ±larÄ±nÄ± gÃ¼ncelle
                    setTimeout(() => {
                        updateBookStatusCounts();
                    }, 500);
                    
                    // Åuan okuyor bÃ¶lÃ¼mÃ¼ kaldÄ±rÄ±ldÄ±
                    
                    // KitaplÄ±k sekmesindeki kitaplarÄ± da gÃ¼ncelle
                    updateLibraryTabs(bookId, status, data);
                    
                    // BaÅŸarÄ± mesajÄ± gÃ¶ster
                    showAlert('success', data.message);
                    
                    // 2 saniye sonra sayfayÄ± yeniden yÃ¼kle (deÄŸiÅŸikliklerin tam olarak gÃ¶rÃ¼nmesi iÃ§in)
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showAlert('danger', data.message || 'Hata oluÅŸtu');
                }
            })
            .catch(error => {
                console.error('Kitap durumu gÃ¼ncellenirken hata:', error);
                showAlert('danger', 'Bir hata oluÅŸtu');
            });
        }

        // Durum metni ve simgesi iÃ§in yardÄ±mcÄ± fonksiyonlar
        function GetStatusText(status) {
            switch (status) {
                case 1: return "OkuyacaklarÄ±m";
                case 2: return "Okuyorum";
                case 3: return "OkuduklarÄ±m";
                default: return "Durum Yok";
            }
        }
        
        function GetStatusIcon(status) {
            switch (status) {
                case 1: return "ğŸ“š";
                case 2: return "ğŸ“–";
                case 3: return "âœ…";
                default: return "ğŸ“š";
            }
        }

        // KitaplÄ±k sekmesindeki kitaplarÄ± gÃ¼ncelle
        function updateLibraryTabs(bookId, newStatus, data) {
            // EÄŸer kitaplÄ±k sayfasÄ± aÃ§Ä±ksa, oradaki kitaplarÄ± da gÃ¼ncelle
            if (window.opener && !window.opener.closed) {
                try {
                    // KitaplÄ±k sayfasÄ±na mesaj gÃ¶nder
                    window.opener.postMessage({
                        type: 'BOOK_STATUS_UPDATED',
                        bookId: bookId,
                        newStatus: newStatus,
                        statusIcon: GetStatusIcon(newStatus),
                        statusText: GetStatusText(newStatus)
                    }, '*');
                } catch (e) {
                    console.log('KitaplÄ±k sayfasÄ± gÃ¼ncellenemedi');
                }
            }
            
            // AynÄ± pencerede kitaplÄ±k sekmesi aÃ§Ä±ksa
            const libraryTabs = document.querySelectorAll('.nav-link[href*="MyBooks"]');
            if (libraryTabs.length > 0) {
                // KitaplÄ±k sekmesindeki kitaplarÄ± gÃ¼ncelle
                updateLibraryTabContent(bookId, newStatus, data);
            }
        }

        // KitaplÄ±k sekmesi iÃ§eriÄŸini gÃ¼ncelle
        function updateLibraryTabContent(bookId, newStatus, data) {
            // TÃ¼m kitaplÄ±k sekmelerindeki kitap kartlarÄ±nÄ± bul
            const allBookCards = document.querySelectorAll('.book-card[data-book-id="' + bookId + '"]');
            
            allBookCards.forEach(bookCard => {
                // Kitap durumunu gÃ¼ncelle
                bookCard.className = `book-card status-${newStatus}`;
                
                // Durum butonunu gÃ¼ncelle
                const statusButton = bookCard.querySelector('.btn-status');
                if (statusButton) {
                    statusButton.innerHTML = `
                        <span class="status-icon">${GetStatusIcon(newStatus)}</span>
                        <span class="status-text d-none d-md-inline">${GetStatusText(newStatus)}</span>
                    `;
                }
                
                // Dropdown menÃ¼deki aktif durumu gÃ¼ncelle
                const dropdownItems = bookCard.querySelectorAll('.dropdown-item');
                dropdownItems.forEach(item => {
                    if (parseInt(item.dataset.status) === newStatus) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            });
        }

        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.querySelector('.profile-container').prepend(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
        
        // KullanÄ±cÄ±nÄ±n alÄ±ntÄ±larÄ±nÄ± yÃ¼kle
        function loadUserQuotes() {
            const quotesList = document.getElementById('userQuotesList');
            if (!quotesList) {
                console.error('userQuotesList elementi bulunamadÄ±');
                return;
            }
            
            const userId = @Model.Id;
            
            // Loading gÃ¶ster
            quotesList.innerHTML = '<div class="loading-quotes"><p>Kitap alÄ±ntÄ±larÄ± yÃ¼kleniyor...</p></div>';
            
            console.log(`KullanÄ±cÄ± alÄ±ntÄ±larÄ± yÃ¼kleniyor. UserId: ${userId}`);
            
            // DoÄŸrudan URL ile istek yap (query string ile doÄŸru baÄŸlama)
            const url = `/Profile/GetUserQuotes?userId=${userId}`;
            console.log(`Ä°stek URL: ${url}`);
            
            // AJAX ile kullanÄ±cÄ±nÄ±n alÄ±ntÄ±larÄ±nÄ± getir
            fetch(url, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json',
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                console.log('Sunucu yanÄ±tÄ±:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error('Sunucu yanÄ±tÄ± baÅŸarÄ±sÄ±z: ' + response.status + ' ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                console.log('AlÄ±ntÄ±lar yanÄ±tÄ±:', data);
                if (data.success) {
                    console.log('AlÄ±ntÄ±lar baÅŸarÄ±yla yÃ¼klendi:', data.quotes);
                    if (data.quotes && data.quotes.length > 0) {
                        displayUserQuotes(data.quotes);
                    } else {
                        console.log('AlÄ±ntÄ± bulunamadÄ±');
                        quotesList.innerHTML = `
                            <div class="no-quotes">
                                <div class="no-quotes-icon">ğŸ’¬</div>
                                <h4>HenÃ¼z Kitap AlÄ±ntÄ±sÄ± Yok</h4>
                                <p>HenÃ¼z hiÃ§ kitap alÄ±ntÄ±sÄ± eklememiÅŸsiniz. OkuduÄŸunuz veya okumakta olduÄŸunuz kitaplardan ilk alÄ±ntÄ±nÄ±zÄ± ekleyin!</p>
                        @if (Model.IsOwnProfile)
                        {
                        <a href="@Url.Action("AddQuote", "Profile")" class="btn btn-primary">
                                    <i class="icon">âœï¸</i> Ä°lk Kitap AlÄ±ntÄ±mÄ± Ekle
                        </a>
                        }
                            </div>
                        `;
                    }
                } else {
                    console.error('AlÄ±ntÄ±lar yÃ¼klenemedi:', data.message);
                    quotesList.innerHTML = `
                        <div class="no-quotes">
                            <div class="no-quotes-icon">âŒ</div>
                            <h4>Hata</h4>
                            <p>Kitap alÄ±ntÄ±larÄ± yÃ¼klenirken bir hata oluÅŸtu: ${data.message || 'Bilinmeyen hata'}</p>
                            <button onclick="loadUserQuotes()" class="btn btn-primary">
                                <i class="icon">ğŸ”„</i> Tekrar Dene
                            </button>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('KullanÄ±cÄ± alÄ±ntÄ±larÄ± yÃ¼klenirken hata:', error);
                quotesList.innerHTML = `
                    <div class="no-quotes">
                        <div class="no-quotes-icon">âŒ</div>
                        <h4>Hata</h4>
                        <p>Kitap alÄ±ntÄ±larÄ± yÃ¼klenirken bir hata oluÅŸtu: ${error.message}</p>
                        <button onclick="loadUserQuotes()" class="btn btn-primary">
                            <i class="icon">ğŸ”„</i> Tekrar Dene
                        </button>
                    </div>
                `;
            });
        }
        
        // KullanÄ±cÄ±nÄ±n alÄ±ntÄ±larÄ±nÄ± gÃ¶rÃ¼ntÃ¼le
        function displayUserQuotes(quotes) {
            const quotesList = document.getElementById('userQuotesList');
            if (!quotesList) return;
            
            if (!quotes || quotes.length === 0) {
                quotesList.innerHTML = `
                    <div class="no-quotes">
                        <div class="no-quotes-icon">ğŸ’¬</div>
                        <h4>HenÃ¼z Kitap AlÄ±ntÄ±sÄ± Yok</h4>
                        <p>HenÃ¼z hiÃ§ kitap alÄ±ntÄ±sÄ± eklememiÅŸsiniz. OkuduÄŸunuz veya okumakta olduÄŸunuz kitaplardan ilk alÄ±ntÄ±nÄ±zÄ± ekleyin!</p>
                        @if (Model.IsOwnProfile)
                        {
                        <a href="@Url.Action("AddQuote", "Profile")" class="btn btn-primary">
                            <i class="icon">âœï¸</i> Ä°lk Kitap AlÄ±ntÄ±mÄ± Ekle
                        </a>
                        }
                    </div>
                `;
                return;
            }
            
            const quotesHTML = quotes.map(quote => createUserQuoteCard(quote)).join('');
            quotesList.innerHTML = quotesHTML;
            
            // Silme butonlarÄ±na event listener ekle
            document.querySelectorAll('.quote-action-btn.delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const quoteId = this.dataset.quoteId;
                    deleteUserQuote(quoteId);
                });
            });
        }
        
        // KullanÄ±cÄ± alÄ±ntÄ± kartÄ± oluÅŸtur
        function createUserQuoteCard(quote) {
            const metaItems = [];
            
            if (quote.author) {
                metaItems.push(`<div class="quote-meta-item"><span class="quote-meta-icon">âœï¸</span> ${quote.author}</div>`);
            }
            
            if (quote.source) {
                metaItems.push(`<div class="quote-meta-item"><span class="quote-meta-icon">ğŸ“–</span> ${quote.source}</div>`);
            }
            
            if (quote.pageNumber > 0) {
                metaItems.push(`<div class="quote-meta-item"><span class="quote-meta-icon">ğŸ“„</span> Sayfa ${quote.pageNumber}</div>`);
            }
            
            const metaHTML = metaItems.length > 0 ? `<div class="quote-meta">${metaItems.join('')}</div>` : '';
            
            const notesHTML = quote.notes ? `
                <div class="quote-notes">
                    <h5>ğŸ“ Notlar</h5>
                    <p>${quote.notes}</p>
                </div>
            ` : '';
            
            return `
                <div class="quote-card" data-quote-id="${quote.id}">
                    <div class="quote-header">
                        <div class="quote-book-info">
                            <img src="${quote.bookCoverImage}" alt="${quote.bookTitle}" class="quote-book-cover">
                            <div class="quote-book-details">
                                <h5 class="quote-book-title">${quote.bookTitle}</h5>
                                <p class="quote-book-author">${quote.bookAuthor}</p>
                            </div>
                        </div>
                        ${quote.canDelete ? `<div class="quote-actions">
                            <button class="quote-action-btn delete" data-quote-id="${quote.id}" title="AlÄ±ntÄ±yÄ± Sil">ğŸ—‘ï¸</button>
                        </div>` : ''}
                    </div>
                    
                    <div class="quote-content">
                        <p class="quote-text">"${quote.content}"</p>
                    </div>
                    
                    ${metaHTML}
                    ${notesHTML}
                    
                    <div class="quote-footer">
                        <span class="quote-date">${quote.createdAt}</span>
                    </div>
                </div>
            `;
        }
        
        // KullanÄ±cÄ± alÄ±ntÄ±sÄ±nÄ± sil
        function deleteUserQuote(quoteId) {
            if (!confirm('Bu alÄ±ntÄ±yÄ± silmek istediÄŸinizden emin misiniz?')) {
                return;
            }
            
            // Form oluÅŸtur ve token ekle
            const form = document.createElement('form');
            form.style.display = 'none';
            form.method = 'POST';
            form.action = '/Book/DeleteQuote';
            
            // CSRF token ekle
            const tokenInput = document.createElement('input');
            tokenInput.type = 'hidden';
            tokenInput.name = '__RequestVerificationToken';
            tokenInput.value = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
            form.appendChild(tokenInput);
            
            // Quote ID ekle
            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'id';
            idInput.value = quoteId;
            form.appendChild(idInput);
            
            // Form'u sayfaya ekle ve gÃ¶nder
            document.body.appendChild(form);
            
            // AJAX ile alÄ±ntÄ± sil
            fetch('/Profile/DeleteQuote', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: new URLSearchParams(new FormData(form))
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Sunucu yanÄ±tÄ± baÅŸarÄ±sÄ±z: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    console.log('AlÄ±ntÄ± baÅŸarÄ±yla silindi:', data);
                    showAlert('success', data.message);
                    
                    // AlÄ±ntÄ± kartÄ±nÄ± kaldÄ±r
                    const quoteCard = document.querySelector(`.quote-card[data-quote-id="${quoteId}"]`);
                    if (quoteCard) {
                        quoteCard.style.animation = 'fadeOut 0.3s ease-out';
                        setTimeout(() => {
                            quoteCard.remove();
                            
                            // EÄŸer hiÃ§ alÄ±ntÄ± kalmadÄ±ysa boÅŸ durumu gÃ¶ster
                            const remainingQuotes = document.querySelectorAll('.quote-card');
                            if (remainingQuotes.length === 0) {
                                loadUserQuotes();
                            }
                        }, 300);
                    }
                } else {
                    console.error('AlÄ±ntÄ± silinemedi:', data.message);
                    showAlert('danger', data.message || 'AlÄ±ntÄ± silinirken bir hata oluÅŸtu.');
                }
            })
            .catch(error => {
                console.error('AlÄ±ntÄ± silinirken hata:', error);
                showAlert('danger', 'AlÄ±ntÄ± silinirken bir hata oluÅŸtu: ' + error.message);
            })
            .finally(() => {
                // Form'u temizle
                document.body.removeChild(form);
            });
        }
    </script>
}

@functions {
    string GetStatusIcon(Entities.ReadingStatus status)
    {
        return status switch
        {
            Entities.ReadingStatus.WantToRead => "ğŸ“š",
            Entities.ReadingStatus.CurrentlyReading => "ğŸ“–",
            Entities.ReadingStatus.Read => "âœ…",
            _ => "ğŸ“š"
        };
    }
    
    string GetStatusText(Entities.ReadingStatus status)
    {
        return status switch
        {
            Entities.ReadingStatus.WantToRead => "OkuyacaklarÄ±m",
            Entities.ReadingStatus.CurrentlyReading => "Okuyorum",
            Entities.ReadingStatus.Read => "OkuduklarÄ±m",
            _ => "Durum Yok"
        };
    }
}