@model UI.Models.BookLibraryViewModel

@{
    ViewData["Title"] = "Kitaplığım";
    Layout = "_Layout";
}

<div class="library-container">
    <!-- Ana Başlık -->
    <div class="library-header">
        <div class="header-content">
            <div class="header-text">
                <h1 class="main-title">
                    <i class="fas fa-book-open"></i>
                    @if (Model.IsCurrentUser)
                    {
                        @if (Model.StatusFilter.HasValue)
                        {
                            <span>
                                @(Model.StatusFilter switch
                                {
                                    1 => "Okuyacaklarım",
                                    2 => "Okuyorum",
                                    3 => "Okuduklarım",
                                    _ => "Kitaplığım"
                                })
                            </span>
                        }
                        else
                        {
                            <span>Kitaplığım</span>
                        }
                    }
                    else
                    {
                        <span>Kullanıcının Kitapları</span>
                    }
                </h1>
                <p class="subtitle">
                    @if (Model.IsCurrentUser)
                    {
                        @if (Model.StatusFilter.HasValue)
                        {
                            @(Model.StatusFilter switch
                            {
                                1 => "Okumayı planladığınız kitaplar",
                                2 => "Şu anda okuduğunuz kitaplar",
                                3 => "Tamamladığınız kitaplar",
                                _ => "Okuma yolculuğunuzu keşfedin ve yönetin"
                            })
                        }
                        else
                        {
                            <span>Okuma yolculuğunuzu keşfedin ve yönetin</span>
                        }
                    }
                    else
                    {
                        <span>Bu kullanıcının kitap koleksiyonu</span>
                    }
                </p>
            </div>
            @if (Model.IsCurrentUser)
            {
                <div class="header-actions">
                    <button class="btn btn-primary btn-search-books" onclick="openSearchModal()">
                        <i class="fas fa-search"></i>
                        Kitap Ara ve Ekle
                    </button>
                </div>
            }
        </div>
    </div>

    <!-- Bildirimler -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success" role="alert">
            <i class="fas fa-check-circle"></i>
            @TempData["SuccessMessage"]
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle"></i>
            @TempData["ErrorMessage"]
        </div>
    }

    <!-- Kitaplık İstatistikleri -->
    <div class="library-stats">
        <div class="stat-card">
            <div class="stat-icon reading">
                <i class="fas fa-book-reader"></i>
            </div>
            <div class="stat-content">
                <span class="stat-number">@Model.CurrentlyReadingCount</span>
                <span class="stat-label">Okuyorum</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon completed">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-content">
                <span class="stat-number">@Model.ReadCount</span>
                <span class="stat-label">Okuduklarım</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon to-read">
                <i class="fas fa-bookmark"></i>
            </div>
            <div class="stat-content">
                <span class="stat-number">@Model.WantToReadCount</span>
                <span class="stat-label">Okuyacaklarım</span>
            </div>
        </div>
    </div>

    <!-- Kitaplık Sekmeleri -->
    <div class="library-tabs">
        <ul class="nav nav-tabs" id="bookStatusTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link @(!Model.StatusFilter.HasValue ? "active" : "")" id="all-tab" href="/Book/MyBooks" role="tab">
                    <i class="fas fa-th-large"></i>
                    Tümü
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link @(Model.StatusFilter == 2 ? "active" : "")" id="reading-tab" href="/Book/MyBooks?statusFilter=2" role="tab">
                    <i class="fas fa-book-reader"></i>
                    Okuyorum
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link @(Model.StatusFilter == 1 ? "active" : "")" id="to-read-tab" href="/Book/MyBooks?statusFilter=1" role="tab">
                    <i class="fas fa-bookmark"></i>
                    Okuyacaklarım
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link @(Model.StatusFilter == 3 ? "active" : "")" id="read-tab" href="/Book/MyBooks?statusFilter=3" role="tab">
                    <i class="fas fa-check-circle"></i>
                    Okuduklarım
                </a>
            </li>
        </ul>
    </div>

    <!-- Kitap İçeriği -->
    <div class="book-content">
        @if (Model.Books != null && Model.Books.Any())
        {
            <div class="books-grid">
                @foreach (var book in Model.Books)
                {
                    <partial name="_BookCard" model='new { Book = book, Model = Model }' />
                }
            </div>
        }
        else
        {
            <div class="empty-state">
                <div class="empty-icon">
                    @if (Model.StatusFilter == 1)
                    {
                        <i class="fas fa-bookmark"></i>
                        <h3>Henüz okumayı planladığınız kitap yok</h3>
                        <p>Okumak istediğiniz kitapları buraya ekleyin!</p>
                    }
                    else if (Model.StatusFilter == 2)
                    {
                        <i class="fas fa-book-reader"></i>
                        <h3>Henüz okumaya başladığınız kitap yok</h3>
                        <p>Şu anda okuduğunuz kitapları buraya ekleyin!</p>
                    }
                    else if (Model.StatusFilter == 3)
                    {
                        <i class="fas fa-check-circle"></i>
                        <h3>Henüz okuduğunuz kitap yok</h3>
                        <p>Okuduğunuz kitapları buraya ekleyin!</p>
                    }
                    else
                    {
                        <i class="fas fa-book"></i>
                        <h3>Henüz kitap eklenmemiş</h3>
                        <p>Kitaplığınıza kitap ekleyerek başlayın!</p>
                    }
                </div>
                <button class="btn btn-primary btn-add-book" onclick="openSearchModal()">
                    <i class="fas fa-search"></i> Kitap Ara ve Ekle
                </button>
            </div>
        }
    </div>
</div>

<!-- CSRF Token -->
@Html.AntiForgeryToken()

@section Styles {
    <link rel="stylesheet" href="~/css/my-books.css" />
}

@section Scripts {
    <script>
        // Modal açma fonksiyonu
        function openSearchModal() {
            $('#searchModal').modal('show');
        }
        
        // Kitap silme fonksiyonu
        function deleteBook(bookId) {
            if (confirm('Bu kitabı silmek istediğinizden emin misiniz?')) {
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                if (!token) {
                    showAlert('danger', 'Güvenlik token\'ı bulunamadı.');
                    return;
                }
                
                // AJAX ile kitap sil
                fetch('/Book/Delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: `id=${bookId}&__RequestVerificationToken=${token}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('success', data.message);
                        
                        // Kitap kartını kaldır
                        const bookCard = document.querySelector(`[data-book-id="${bookId}"]`);
                        if (bookCard) {
                            bookCard.style.animation = 'fadeOut 0.3s ease-out';
                            setTimeout(() => {
                                bookCard.remove();
                                
                                // Eğer hiç kitap kalmadıysa sayfayı yenile
                                const remainingBooks = document.querySelectorAll('.book-card');
                                if (remainingBooks.length === 0) {
                                    location.reload();
                                }
                            }, 300);
                        }
                    } else {
                        showAlert('danger', data.message || 'Kitap silinirken bir hata oluştu.');
                    }
                })
                .catch(error => {
                    console.error('Kitap silinirken hata:', error);
                    showAlert('danger', 'Kitap silinirken bir hata oluştu.');
                });
            }
        }
        
        // Kitap düzenleme fonksiyonu
        function editBook(bookId) {
            window.location.href = '/Book/Edit/' + bookId;
        }
        
        // Kitap durumu güncelleme fonksiyonu
        function updateBookStatus(bookId, status) {
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
            if (!token) {
                showAlert('danger', 'Güvenlik token\'ı bulunamadı.');
                return;
            }
            
            // Loading göster
            const bookCard = document.querySelector(`[data-book-id="${bookId}"]`);
            const statusButton = bookCard?.querySelector('.btn-status');
            if (statusButton) {
                const originalText = statusButton.innerHTML;
                statusButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Güncelleniyor...';
                statusButton.disabled = true;
            }
            
            // AJAX ile durum güncelle
            fetch('/Book/UpdateReadingStatus', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: `bookId=${bookId}&readingStatus=${status}&__RequestVerificationToken=${token}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', data.message);
                    
                    // Kitap kartını güncelle
                    if (bookCard) {
                        // Durum butonunu güncelle
                        const statusIcon = bookCard.querySelector('.status-icon');
                        const statusText = bookCard.querySelector('.status-text');
                        
                        if (statusIcon && statusText) {
                            statusIcon.innerHTML = data.statusIcon;
                            statusText.textContent = data.statusText;
                        }
                        
                        // Kart sınıfını güncelle
                        bookCard.className = bookCard.className.replace(/to-read-status|reading-status|completed-status/g, '');
                        switch(data.status) {
                            case 1:
                                bookCard.classList.add('to-read-status');
                                break;
                            case 2:
                                bookCard.classList.add('reading-status');
                                break;
                            case 3:
                                bookCard.classList.add('completed-status');
                                break;
                        }
                        
                        // Dropdown'daki aktif durumu güncelle
                        const dropdownItems = bookCard.querySelectorAll('.dropdown-item');
                        dropdownItems.forEach(item => {
                            item.classList.remove('active');
                            if (parseInt(item.dataset.status) === data.status) {
                                item.classList.add('active');
                            }
                        });
                    }
                    
                    // İstatistikleri güncelle
                    updateStats();
                } else {
                    showAlert('danger', data.message || 'Kitap durumu güncellenirken bir hata oluştu.');
                }
            })
            .catch(error => {
                console.error('Kitap durumu güncellenirken hata:', error);
                showAlert('danger', 'Kitap durumu güncellenirken bir hata oluştu.');
            })
            .finally(() => {
                // Loading'i kaldır
                if (statusButton) {
                    statusButton.disabled = false;
                    // Orijinal metni geri yükle (eğer hata varsa)
                    if (statusButton.innerHTML.includes('Güncelleniyor')) {
                        statusButton.innerHTML = statusButton.innerHTML.replace('Güncelleniyor...', 'Durum');
                    }
                }
            });
        }
        
        // İstatistikleri güncelle
        function updateStats() {
            // Sayfayı yenile (basit çözüm)
            setTimeout(() => {
                location.reload();
            }, 1000);
        }
        
        // Alert gösterme
        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Alert'i sayfanın üstüne ekle
            const container = document.querySelector('.library-container');
            if (container) {
                container.insertBefore(alertDiv, container.firstChild);
            }
            
            // 3 saniye sonra otomatik kaldır
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }
    </script>
} 
